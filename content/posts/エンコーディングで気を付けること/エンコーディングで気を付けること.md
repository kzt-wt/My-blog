---
title: "機械学習のエンコーディングで気を付けること"
date: 2022-01-03T20:00:20+09:00
lastmod:
draft: false
tags: [kaggle]
categories: [kaggle]
authors:
weight: 1
description: "House Priceコンペで苦戦したことを共有します。"
featuredImage: "https://user-images.githubusercontent.com/87252429/148060490-63d50fbb-1e3a-4630-9f34-5ef0ceddff65.png"
images: ["https://user-images.githubusercontent.com/87252429/148060490-63d50fbb-1e3a-4630-9f34-5ef0ceddff65.png"]
lightgallery: true
---

## 背景
[House Priceコンペ](https://www.kaggle.com/c/house-prices-advanced-regression-techniques)で苦戦したことを共有します。

実際、一番苦戦したのがこのエンコーディングです。


## 間違ったエンコーディング
まず**訓練用データ**のみでエンコーディング(訓練データのみエンコーディングしたのがまずかった...)
``` python
df=pd.read_csv("../input/house-prices-advanced-regression-techniques/train.csv")
df_test=pd.read_csv("../input/house-prices-advanced-regression-techniques/test.csv")
"""
～～～～～～～～～～～～
省略
～～～～～～～～～～～～
"""
X=df.drop("SalePrice",axis=1)
y=df["SalePrice"]

#cat_colsはエンコーディングするカテゴリーのリスト
X_encoded=pd.get_dummies(X,columns=cat_cols)
```


ちょっと飛びますが、predict()で予測...
``` python
finally_alpha_val=0.1
elastic_net = ElasticNet(alpha=0.1)
elastic_net.fit(X_train,y_train)
submit_prediction=elastic_net.predict(X_pred)

---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
~\AppData\Local\Temp/ipykernel_1396/553432860.py in <module>
      2 elastic_net = ElasticNet(alpha=0.1)
      3 elastic_net.fit(X_train,y_train)
----> 4 submit_prediction=elastic_net.predict(X_pred)

~\AppData\Local\Programs\Python\Python39\lib\site-packages\sklearn\linear_model\_base.py in predict(self, X)
    360             Returns predicted values.
    361         """
--> 362         return self._decision_function(X)
    363 
    364     _preprocess_data = staticmethod(_preprocess_data)

~\AppData\Local\Programs\Python\Python39\lib\site-packages\sklearn\linear_model\_coordinate_descent.py in _decision_function(self, X)
   1098             return safe_sparse_dot(X, self.coef_.T, dense_output=True) + self.intercept_
   1099         else:
-> 1100             return super()._decision_function(X)
   1101 
   1102 

~\AppData\Local\Programs\Python\Python39\lib\site-packages\sklearn\linear_model\_base.py in _decision_function(self, X)
    343         check_is_fitted(self)
    344 
--> 345         X = self._validate_data(X, accept_sparse=["csr", "csc", "coo"], reset=False)
    346         return safe_sparse_dot(X, self.coef_.T, dense_output=True) + self.intercept_
    347 

~\AppData\Local\Programs\Python\Python39\lib\site-packages\sklearn\base.py in _validate_data(self, X, y, reset, validate_separately, **check_params)
    574 
    575         if not no_val_X and check_params.get("ensure_2d", True):
--> 576             self._check_n_features(X, reset=reset)
    577 
    578         return out

~\AppData\Local\Programs\Python\Python39\lib\site-packages\sklearn\base.py in _check_n_features(self, X, reset)
    393 
    394         if n_features != self.n_features_in_:
--> 395             raise ValueError(
    396                 f"X has {n_features} features, but {self.__class__.__name__} "
    397                 f"is expecting {self.n_features_in_} features as input."

ValueError: X has 53 features, but ElasticNet is expecting 59 features as input.
```
あれエラーメッセージ?

`ValueError: X has 53 features, but ElasticNet is expecting 59 features as input.`

訳: Xは53個の特徴量を持っていますが、ElasticNetは59個の特徴量を入力として想定しています。

## 正しいエンコーディング
先ほどとは違い、**訓練用データ＋テスト用データ**を結合してからの*エンコーディング*していきます。
``` python
df=pd.read_csv("../input/house-prices-advanced-regression-techniques/train.csv")
df_test=pd.read_csv("../input/house-prices-advanced-regression-techniques/test.csv")
"""
～～～～～～～～～～～～
省略
～～～～～～～～～～～～
"""
X=df.drop("SalePrice",axis=1)
y=df["SalePrice"]

X["for_train"]=True
df_test["for_train"]=False

#データを結合
df_all_data=pd.concat([X,df_test])
#エンコーディング
encoded_all_data=pd.get_dummies(df_all_data,columns=cat_cols)
#データを訓練用とテスト用に分ける
X=encoded_all_data.loc[encoded_all_data["for_train"]]
X_pred=encoded_all_data.loc[~encoded_all_data["for_train"]]
```
predict()で予測...
``` python
finally_alpha_val=0.1
elastic_net = ElasticNet(alpha=0.1)
elastic_net.fit(X_train,y_train)
submit_prediction=elastic_net.predict(X_pred)
```
特にエラーは起きませんでした。

## 原因
原因は訓練・テスト用データで分けた状態で`pd.get_dummies`を使っていたから。

訓練用とテスト用でカラム数が変わってしまったため`pd.get_dummies`に怒られたようです。

`pd.get_dummies`を使うときは検証用・テスト用データを結合してから使うようにしましょう。

